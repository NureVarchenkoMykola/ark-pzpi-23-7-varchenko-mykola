Міністерство освіти і науки України
Харківський національний університет радіоелектроніки
Кафедра програмної інженерії






Звіт
з лабораторної роботи №5
з предмету «Аналіз та рефакторинг коду»





Виконав: 
ст. гр. ПЗПІ 23-7
Варченко Микола Миколайович

Прийняв:
Дашенков Д.С.







Харків 2025
    1 Розгортання бази даних
     Для розгортання бази даних було використано вже наявну структуру та дані з локального середовища. У phpMyAdmin виконано експорт поточної бази даних у форматі SQL, щоб зафіксувати всі таблиці та початкові записи в одному дампі. Після цього у Railway створено окремий сервіс бази даних MySQL і виконано імпорт дампу. Таким чином, розроблена система отримала віддалену базу даних, доступну з хмарного середовища та придатну для підключення серверної частини. Імпорт виконувався за допомогою файлу import-railway.mjs:
       import fs from 'fs/promises'
       import mysql from 'mysql2/promise'
       
       async function main() {
         const filePath = process.argv[2]
         if (!filePath) {
           console.error('Usage: node import-railway.mjs path/to/energy_tracker.sql')
           process.exit(1)
         }
       
         const host = 'ballast.proxy.rlwy.net'
         const port = 54378
         const user = 'root'
         const password = 'pAXCvhXgUtuMKHRunFshcAySPXHZQtjq'
         const database = 'railway'
       
         let sql = await fs.readFile(filePath, 'utf8')
       
         sql = sql
           .split(/\r?\n/)
           .filter((line) => {
             const t = line.trim()
             if (/^CREATE DATABASE\b/i.test(t)) return false
             if (/^USE\b/i.test(t)) return false
             return true
           })
           .join('\n')
       
         const conn = await mysql.createConnection({
           host,
           port,
           user,
           password,
           database,
           multipleStatements: true
         })
       
         try {
           await conn.query(sql)
           console.log('Import OK')
         } finally {
           await conn.end()
         }
       }
       
       main().catch((e) => {
         console.error('Import failed')
         console.error(e?.message || e)
         process.exit(1)
       })
     Поряд зі скриптом у структурі проєкту сам знаходився файл із даними energy_tracker.sql. Підготовка середовища виконання та інсталяція необхідних модулів Node.js були виконані з використанням менеджера пакетів npm.

     Після створення бази в Railway отримано параметри підключення, які використовуються сервером через змінні середовища. У налаштуваннях середовища вказуються хост, порт, назва бази, користувач і пароль, які Railway надає для створеного інстансу. У результаті серверна частина може виконувати автентифікацію до БД та працювати з таблицями users, appliances, tariffs, consumption_records, limits, audit_logs без змін у схемі даних.


Рис. 1 – Сторінка phpMyAdmin з процесом експорту бази даних

Рис. 2 – Створений сервіс MySQL у Railway


Рис. 3 – Видані параметри підключення
    2 Розгортання серверної частини у Render
     Серверну частину системи розгорнуто у Render як Web Service для Node.js. Репозиторій із серверною логікою, без підключення локальної бази даних, під’єднано до Render, після чого налаштовано збірку та запуск застосунку. Під час деплою застосунок встановлює залежності та запускає сервер, який піднімає REST API і документацію Swagger.
     Щоб сервер працював із віддаленою базою даних, у Render задано змінні середовища для підключення до Railway MySQL. Також задано секрет для JWT, оскільки авторизація в системі реалізована через токен і middleware перевіряє його при доступі до захищених маршрутів. Після коректного налаштування змінних середовища сервер успішно підключається до бази даних, що підтверджується логами з повідомленням про встановлене з’єднання з БД.
     Перевірка працездатності розгорнутої системи виконувалась через endpoint здоров’я та через Swagger UI:
       https://ark-pzpi-23-7-varchenko-mykola.onrender.com/health
       https://ark-pzpi-23-7-varchenko-mykola.onrender.com/api/docs/
     Endpoint /health повертає очікувану відповідь про працездатність сервісу. Swagger UI успішно відкривається за адресою /api/docs та дає змогу виконувати тестові запити до маршрутів автентифікації, приладів, тарифів, споживання та лімітів. Оскільки кореневий маршрут https://ark-pzpi-23-7-varchenko-mykola.onrender.com не визначений, при переході на головну адресу сервісу відображається відповідь «Cannot GET /», що не є помилкою для API-орієнтованого сервісу і не впливає на доступність /api/docs та /health.

Рис. 4 – Деплой проєкту на Render

Рис. 5 – Деплой проєкту на Render


Рис. 6 – Створений сервіс на Render


Рис. 7 – Swagger UI відкритий за адресою виданою Render
    3 Розгортання та перевірка IoT клієнта у Wokwi
     IoT клієнт реалізовано на базі ESP32 у середовищі симуляції Wokwi. Це дозволяє запускати пристрій як віддалений компонент системи без локальної апаратної плати, лише у браузері. У конфігурації клієнта задано адресу розгорнутого API у Render, а взаємодія з сервером здійснюється через HTTPS запити та JWT-автентифікацію.
     Під час роботи IoT клієнт підключається до Wi-Fi мережі Wokwi та отримує токен доступу через запит авторизації. Далі клієнт надсилає дані споживання на сервер через endpoint додавання запису споживання і паралельно опитує ліміти споживання через endpoints отримання списку лімітів на поточну дату та прогресу конкретного ліміту. На основі відповіді сервера пристрій формує локальні стани попередження та блокування. При досягненні порогу або перевищенні ліміту активується світлодіод попередження та звуковий сигнал, а при перевищенні ліміту навантаження примусово вимикається, щоб продемонструвати автоматичну реакцію SmartDevice на серверні правила.
     Перевірка працездатності IoT клієнта виконувалась у Wokwi через спостереження індикації на дисплеї, реакції реле та попереджувальних сигналів. Додатково результат інтеграції підтверджується появою нових записів споживання у базі даних і можливістю їх перегляду.

Рис.8 – Записи споживання з’являються в  Swagger

Рис.9 – Записи споживання з’являються в  бд на Railway


Рис.10 – Схема Wokwi з ESP32 та підключеними компонентами
ДОДАТОК А
Посилання на відео: https://youtu.be/UGfO-6G0X2I
